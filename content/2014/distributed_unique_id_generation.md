Title: Distributed Unique Id Generation
Date: 2014-11-04 16:20 
Author: Ray Chen 
Category: System

Real-World Case Studies:

+ Flickr needs globally unique primary keys for their MySQL shards, because they need to migrate data between databases, and also their MySQL shards are built as master-master replicant pairs. [1]
+ Twitter needs unique, roughly sortable, 64-bit unsigned integers for Tweet IDs. [2]

### Why not UUID?

The intent of Universally Unique Identifier (**UUID**) is to enable distributed systems to uniquely identify information without significant central coordination. 
```java
System.out.println(UUID.randomUUID().toString());
```

Why not just use UUID?

+ A UUID is a 128-bit number. There are big overhead when **indexes** in DBs refer to the primary key using UUIDs. We need keep indexes in memory to make database fast. They must fit into **64 bits**.
+ UUIDs are generated random (Version 4) or using MAC address & date-time (Version 1). Their lexical ordering is essentially meaningless. When fetching data in continuous pages, we can see performance loss, because primary keys using UUIDs are random and data is scattered across the B+ Tree. Ids need to be roughly **sortable**. 

### Requirements in Distributed Unique Id Generation

The requirements to generate a unique Id within a distributed environment in consideration of scalability are as follows:

+ Ids must be guaranteed globally unique.
+ Ids must fit into 64-bits.
+ Ids must be roughly sortable.
+ The assigned Id is gone forever after the client's request and can't be reused for subsequent assignment.
+ Id generation service must be running on multiple nodes to avoid SPOFs.
+ Id generation service needs to be scalable with respects to growth of requests.

### General Solution

Using a general distributed computing scheme, there will be a pool of Id generators ("**workers**") residing in many inter-connected commodity machines. Clients requesting a unique Id may locate in the same worker, or reside inseperate workers. A load balancer may sit between the clients and the workers to evenly distribute workload. Workers must coordinate with each other to guarantee globally unique Ids.

### Centralized Ticket Server

One straightword approach is to provide a centralized ticket server which maintains an auto-incremental integer number. For example, Flickr uses MySQL-based ticket server. To generate a new globally unique 64-bit Id, issue the following SQL:
```sql
REPLACE INTO Tickets64 (stub) VALUES ('a');
SELECT LAST_INSERT_ID();
```
To avoid SPOF issue, Flickr achieve "**high availability**" by running two ticket servers, and divide responsibility by dividing the ID space, evens and odds. Then, they round robin between the two servers to load balance.

### Decentralized Snowflake Service

Twitter's Snowflake provides a service to generate unique Tweet Ids. These Tweet Ids are unique 64-bit unsigned integers, sequential based on time. To generate the roughly-sorted 64-bit Ids in an **uncoordinated** manner, Snowflake generates Ids composed of: **timestamp**, **worker id** and **sequence number**. Sequence numbers are per-thread and worker ids are chosen at startup via ZooKeeper. Worker id is required to avoid any conflict between the unique ids generated by multiple machines.

### Other Options

This blog post "Distributed UUID Generation" proposed several good approaches:

+ Use a centralized server to maintains a counter. Workers (Id generators) can request a "*Id range*" instead of the Id itself, and Id assignment is done locally by the worker.
+ Use peer multicast to re-allocate Id ranges between workers. 
+ Use distributed hashtable to distribute Id ranges implicitly within a ring of works.

## Reference

+ [Ticket Servers: Distributed Unique Primary Keys on the Cheap](http://code.flickr.net/2010/02/08/ticket-servers-distributed-unique-primary-keys-on-the-cheap)
+ [Announcing Snowflake](https://blog.twitter.com/2010/announcing-snowflake)
+ [Sharding & IDs at Instagram](http://instagram-engineering.tumblr.com/post/10853187575/sharding-ids-at-instagram)
+ [Distributed UUID Generation](http://horicky.blogspot.com/2007/11/distributed-uuid-generation.html)

[1]:http://code.flickr.net/2010/02/08/ticket-servers-distributed-unique-primary-keys-on-the-cheap
[2]:https://blog.twitter.com/2010/announcing-snowflake
