<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Distributed Key-Value Store</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Distributed Key-Value Store"/>
            <meta property="og:url" content="http://www.raydevblog.us/posts/2014/distributed-key-value-store.html"/>
            <meta property="og:description" content="Special thanks go to Berkeley CS162 course providing a nice document and starter code for a distributed key-value store system design. Overview This distributed key-value storage system has multiple clients communicating with a single master server in a given messaging format. The master server contains a set-associative cache, and it ..."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://www.raydevblog.us/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://www.raydevblog.us/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://www.raydevblog.us/theme/css/bootstrap-glyphicons.css" rel="stylesheet">
    <link href="http://www.raydevblog.us/theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="http://www.raydevblog.us/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>

        <link href="http://www.raydevblog.us/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Ray's Thoughts and Writings ATOM Feed"/>

    <!-- Latex -->
        
    <script type= "text/javascript">
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.src = 'https:' == document.location.protocol ? 'https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js' : 'http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; 
        s[(window.opera ? "innerHTML" : "text")] =
            "MathJax.Hub.Config({" + 
            "    config: ['MMLorHTML.js']," + 
            "    jax: ['input/TeX','input/MathML','output/HTML-CSS','output/NativeMML']," +
            "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," + 
            "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
            "    tex2jax: { " +
            "        inlineMath: [ ['$','$'] ], " +
            "        displayMath: [ ['$$','$$'] ]," +
            "        processEscapes: true }, " +
            "    'HTML-CSS': { " +
            "        styles: { '.MathJax .mo, .MathJax .mi': {color: 'black ! important'}} " +
            "    } " +
            "}); ";
        (document.body || document.getElementsByTagName('head')[0]).appendChild(s);
    </script>

  

</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://www.raydevblog.us" class="navbar-brand">Ray's Thoughts and Writings</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://www.raydevblog.us/category/algorithm.html">Algorithm</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/hadoop.html">Hadoop</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/java.html">Java</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/machine-learning.html">Machine Learning</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/miscellaneous.html">Miscellaneous</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/python.html">Python</a>
                        </li>
                        <li class="active">
                            <a href="http://www.raydevblog.us/category/system-design.html">System Design</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://www.raydevblog.us/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://www.raydevblog.us/posts/2014/distributed-key-value-store.html"
                       rel="bookmark"
                       title="Permalink to Distributed Key-Value Store">
                        Distributed Key-Value Store
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>Thu 10 April 2014
    </span>



<span class="label label-default">Tags</span>
	<a href="http://www.raydevblog.us/tag/key-value-store.html">key-value store</a>
        /
	<a href="http://www.raydevblog.us/tag/concurrency.html">concurrency</a>
        /
	<a href="http://www.raydevblog.us/tag/distributed.html">distributed</a>
        /
	<a href="http://www.raydevblog.us/tag/two-phase-commit.html">two-phase commit</a>
        /
	<a href="http://www.raydevblog.us/tag/consistent-hashing.html">consistent hashing</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Special thanks go to Berkeley CS162 course providing a nice document and starter code for 
a distributed key-value store system design.</p>
<h2>Overview</h2>
<p>This distributed key-value storage system has multiple clients communicating 
with a single master server in a given messaging format. The master server contains a set-associative 
cache, and it uses the cache to serve GET requests without going to the key-value slave servers it
coordinates. The slave servers are contacted for a GET request only upon a cache miss on the master. 
The master will forward PUT and DEL client requests to multiple slave servers and follow the two-phase 
commit protocol (2PC) for atomic PUT and DEL operations across multiple slave servers.</p>
<p>The figure below shows an example distributed key-value storage system.
Three clients send a master server simultaneous requests, and the master server coordinates with three
slave servers.
<img alt="Alt text" src="http://www.raydevblog.us/images/distributed_kvstore_master.jpeg" /></p>
<h2>Registration</h2>
<p>Slave servers will send to the master a registration message with a 64-bit globally unique ID 
when they start.</p>
<ul>
<li>The master listens for registration requests from slaves on port 9090.</li>
<li>When a slave starts it should listen in a random free port for 2PC requests, and register that port
number with the master so that the master can send requests to it.</li>
<li>Assuming no errors regarding registration, the master sends a response and the slave accepts the response.</li>
</ul>
<h2>Consistent Hashing</h2>
<ul>
<li>Each key will be stored using 2PC in <strong>two</strong> slave servers; the first of them will be selected using
consistent hashing, while the second will be placed in the successor of the first one.</li>
<li>The master will hash the key to 64-bit address space, because each slave server has a unique 64-bit ID.</li>
<li>Each slave will store the first copies of key with hash values greater than the ID of its immediate
predecessor up to its own ID, and also the keys whose first copies are stored in its predecessor. </li>
</ul>
<h2>Two-phase Commit</h2>
<ul>
<li>The master will select replica locations using consistent hashing.</li>
<li>A slave will send vote-abort to the master if the key does not exist for DEL, or invalid key/value;</li>
<li>When sending phase-1 requests, the master must contact slaves, even if the first slave sends an abort. The master
does this by sequentially making the requests or concurrently by forking off threads.</li>
<li>Only a single 2PC operation can be executed at a time. The master does not support concurrent update
operations across different keys, but GET operations of different keys must be concurrent unless restricted
by an ongoing update operation on the same set.</li>
</ul>
<h2>Failures, Timeouts, and Recovery</h2>
<p>For this particular design, assume that the master will never go down. However, slave servers must log
necessary information to survive from failures.</p>
<ul>
<li>When the slave comes back with the same ID, it will be rebuilt using the log, and know if the last 
request it received was a phase-1 or phase-2 request.</li>
<li>If a slave crashes during phase-1, if master does not get a vote within a single timeout period, it should
assume the slave voted abort.</li>
<li>If a slave crashes during phase-2, the master must retry until it receives a response to its decision. 
Note that when the slave restarts, it may bind to a new port and re-register. The master must retry with
the latest port the slave has registered with. </li>
</ul>
<h2>Components</h2>
<p>Master Server = TPCMaster + SocketServer attached (port 8080) with KVClientHandler
TPCMaster = Master Cache + SocketServer attached (port 9090) with TPCRegistrationHandler
Slave Server = TPCLog + KVServer + SocketServer (free port) attached with TPCMasterHandler</p>
<h2>Java Source Code Breakdown</h2>
<ul>
<li>TPCMasterHandler.java: a network handler to handler 2PC operation requests from the master server.</li>
</ul>
<p>The latest Java source code of my implementation is available in my <a href="https://github.com/garudareiga/computer_system_design/tree/master/distributed_kvstore/src/edu/berkeley/cs162">github repository</a></p>
            </div>
            <!-- /.entry-content -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'garudareiga'; // required: replace example with your forum shortname
            var disqus_identifier = 'distributed-key-value-store';
            var disqus_url = 'http://www.raydevblog.us/posts/2014/distributed-key-value-store.html';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="http://www.linkedin.com/in/leichen1983"><i
                            class="icon-linkedin-sign icon-large"></i>linkedin
                    </a></li>
                    <li class="list-group-item"><a href="https://twitter.com/garudareiga"><i
                            class="icon-twitter-sign icon-large"></i>twitter
                    </a></li>
                    <li class="list-group-item"><a href="https://github.com/garudareiga"><i
                            class="icon-github-sign icon-large"></i>github
                    </a></li>
                    <li class="list-group-item"><a href="http://www.raydevblog.us/feeds/all.atom.xml"><i
                            class="icon-rss-sign icon-large"></i>rss
                    </a></li>



            <li class="list-group-item"><a href="http://www.raydevblog.us/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                <li class="list-group-item tag-1">
                    <a href="http://www.raydevblog.us/tag/concurrency.html">
                        concurrency
                    </a>
                </li>
                <li class="list-group-item tag-1">
                    <a href="http://www.raydevblog.us/tag/key-value-store.html">
                        key-value store
                    </a>
                </li>
                <li class="list-group-item tag-2">
                    <a href="http://www.raydevblog.us/tag/java.html">
                        java
                    </a>
                </li>
                <li class="list-group-item tag-2">
                    <a href="http://www.raydevblog.us/tag/python.html">
                        python
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/consistent-hashing.html">
                        consistent hashing
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/distributed.html">
                        distributed
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/json.html">
                        json
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/two-phase-commit.html">
                        two-phase commit
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/data-mining.html">
                        data mining
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/mongodb.html">
                        mongodb
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/logging.html">
                        logging
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/machine-learning.html">
                        machine learning
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/algorithm.html">
                        algorithm
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/hadoop.html">
                        hadoop
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="http://www.raydevblog.us/tag/mapreduce.html">
                        mapreduce
                    </a>
                </li>
        </ul>
    </section>
</aside>        </div>
    </div>
</div>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://www.raydevblog.us/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://www.raydevblog.us/theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'garudareiga'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
</body>
</html>