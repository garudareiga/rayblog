<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Implementing a Multi-Client Echo Server using Go - Ray's Thoughts and Writings</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://www.raydevblog.us/posts/2014/implementing-a-multi-client-echo-server-using-go.html">

        <meta name="author" content="Ray Chen" />
        <meta name="description" content="Server Characteristic The multi-client echo server must have the following characteristics: The server must manage and interact with its clients concurrently using goroutines and channels. Multiple clients should be able to connect/disconnect to the server simultaneously. When the server reads a newline-terminated message from a client, it must respond ..." />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://www.raydevblog.us/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://www.raydevblog.us/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://www.raydevblog.us/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://www.raydevblog.us/theme/css/style.css" type="text/css"/>

        <link href="http://www.raydevblog.us/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Ray's Thoughts and Writings ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://www.raydevblog.us/" class="navbar-brand">
Ray's Thoughts and Writings            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://www.raydevblog.us/category/algorithm.html">Algorithm</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/data.html">Data</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/java.html">Java</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/misc.html">Misc</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/python.html">Python</a>
                        </li>
                        <li class="active">
                            <a href="http://www.raydevblog.us/category/system.html">System</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://www.raydevblog.us/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://www.raydevblog.us/posts/2014/implementing-a-multi-client-echo-server-using-go.html"
                       rel="bookmark"
                       title="Permalink to Implementing a Multi-Client Echo Server using Go">
                        Implementing a Multi-Client Echo Server using Go
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-09-05T10:00:00"> Fri 05 September 2014</time>
    </span>



    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h3>Server Characteristic</h3>
<p>The multi-client echo server must have the following characteristics:</p>
<ul>
<li>The server must manage and interact with its clients concurrently using goroutines and channels. Multiple clients should be able to connect/disconnect to the server simultaneously. </li>
<li>When the server reads a newline-terminated message from a client, it must respond by writing that exact message to all connected clients. </li>
<li>The server must be responsive to slow-reading clients. Consider when a client does not call <em>Read</em> for an extended period of time. If during this time the server continues to write messages to the client's TCP connection, eventually the TCP connection's output buffer will reach maximum capacity and subsequent calls to <em>Write</em> made by the server will block. The server should keep a queue of at most 100 outgoing messages to be written to the client. Messages sent to a slow-reading client whose outgoing message buffer has reached the maximum capacity of 100 should simply be dropped.</li>
</ul>
<h3>Go's Concurrency Model</h3>
<p>Go's approach to concurrency differs from the traditional use of threads and shared memory. Go encourages an approach in which shared values are passed around on channels and never actively shared by separate threads of execution. It can be summarized:</p>
<blockquote>
<p>Don't communicate by sharing memory; share memory by communicating.</p>
</blockquote>
<p>As a high-level approach, using channels to control access makes it easier to write clear, correct programs.</p>
<h4>Goroutines</h4>
<p>Goroutine is a functon executing concurrently with other goroutines in the same address space. They are lightweight and cheap, costing little more than the allocation of small stack space. Goroutines are multiplexed onto multiple OS threads, hiding the complexities of thread creation and management. They silently manages their own threading, and silently returns when they have finished.</p>
<h4>Channels</h4>
<p>Channels act like pipes. By default, the channel is unbuffered, which provides communication with synchronization. A buffered channel is asynchronous; sending or receiving will not wait unless the channel is full. It can be used like a semaphore, for instance to limit throughput. Channels allow you to pass references to data structures between goroutines. If consider this as passing around ownership of the data (the ability to read and write it), it becomes a powerful synchronization mechanism.</p>
<h3>Echo Server Implementation</h3>
<p>Next I'll explain some Go-specific mechanisms to meet the design requirement. </p>
<h4>Support Clients Concurrently</h4>
<p>When the server starts, it creates a central goroutine that opens a socket and keeps listening for incoming TCP requests on a given port. For each TCP request from a client, the server creates two goroutines for reading from and writing to the connection. When client disconnects from the server, these two goroutines will finish silently. Thus, server is able to interact with mutliple clients concurrently.</p>
<h4>Avoid Data Race</h4>
<p>A data race occurs when two goroutines access the same variable concurrently and at least one of the accesses is a write. The server manages clients using a map, unique client ids as keys and pointers of client objects as values. This map is a goroutine-global variable. In order to avoid data race, its ownership has to be passed around goroutines, adding/deleting clients when clients connect/disconnect to the server concurrently. I choose to use a channel <strong>eclChan</strong> of size one, that stores the map and acts like a binary semaphore (or mutex) to provide synchronization among goroutines.</p>
<div class="highlight"><pre><span class="c1">// New creates and returns (but does not start) a new MultiEchoServer.</span>
<span class="kd">func</span> <span class="nx">New</span><span class="p">()</span> <span class="nx">MultiEchoServer</span> <span class="p">{</span>
    <span class="nx">ptrServer</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">multiEchoServer</span><span class="p">{</span>
        <span class="nx">host</span><span class="p">:</span>    <span class="s">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="nx">eclChan</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="o">*</span><span class="nx">echoClient</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">stop</span><span class="p">:</span>    <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">MultiEchoServer</span><span class="p">(</span><span class="nx">ptrServer</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h4>Use Message Queue</h4>
<p>To be responsive to possible slow <strong>READ</strong> clients, we need a message queue of at most 100 outgoing messages for each client. Apparently, a buffered string channel named as <strong>"ch"</strong> fits this role:</p>
<div class="highlight"><pre><span class="kd">type</span> <span class="nx">echoClient</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span>
    <span class="nx">ch</span>   <span class="kd">chan</span> <span class="kt">string</span>
<span class="p">}</span>
</pre></div>


<p>To drop messages when the channel is full, I asked for some help from <a href="http://stackoverflow.com/questions/25657207/golang-how-to-know-a-buffered-channel-is-full?noredirect=1#comment40125761_25657207">stackoverflow</a> and solve the issue using the <strong>select</strong> statement:</p>
<div class="highlight"><pre><span class="k">select</span> <span class="p">{</span>
<span class="k">case</span> <span class="nx">echoClient</span><span class="p">.</span><span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">msg</span><span class="p">:</span>
<span class="k">default</span><span class="p">:</span> <span class="c1">// discard value if channel is full</span>
<span class="p">}</span>
</pre></div>


<h4>Stop Server Gracefully</h4>
<p>When the server stops, I need terminate the central goroutine listening on a given port gracefully. Here, an unbuffered boolean channel <strong>stop</strong> (defined in <strong>MultiEchoServer</strong> type above) will pass the termination signal to the central goroutine, and the magic <strong>select</strong> statement again decide when to emit the signal:</p>
<div class="highlight"><pre><span class="c1">// central goroutine</span>
<span class="k">for</span> <span class="p">{</span>
    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mes</span><span class="p">.</span><span class="nx">ln</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span> <span class="c1">// listen for TCP connections</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">mes</span><span class="p">.</span><span class="nx">stop</span><span class="p">:</span> <span class="c1">// stop listening</span>
            <span class="k">return</span>
        <span class="k">default</span><span class="p">:</span>
        <span class="p">}</span>
        <span class="k">continue</span>
    <span class="p">}</span>
    <span class="c1">// create goroutines for each connection from clients ...</span>
<span class="p">}</span>
</pre></div>


<h3>Finished</h3>
<p>We now have a fully functional echo server that supports multiple clients concurrently. The full source code for a multi-client echo server is available <a href="https://github.com/garudareiga/cmu-440/tree/master/p0">here</a>. Your criticism or suggestion is welcome.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'garudareiga'; // required: replace example with your forum shortname

                    var disqus_identifier = 'implementing-a-multi-client-echo-server-using-go';
                var disqus_url = 'http://www.raydevblog.us/posts/2014/implementing-a-multi-client-echo-server-using-go.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item"><a href="http://www.linkedin.com/in/leichen1983"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
                    <li class="list-group-item"><a href="https://twitter.com/garudareiga"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
                    <li class="list-group-item"><a href="https://github.com/garudareiga"><i class="fa fa-github-square fa-lg"></i> github</a></li>
                    <li class="list-group-item"><a href="http://www.raydevblog.us/feeds/all.atom.xml"><i class="fa fa-rss-square fa-lg"></i> rss</a></li>
                  </ul>
                </li>



                <li class="list-group-item"><a href="http://www.raydevblog.us/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                    <ul class="list-group " id="tags">
                        <li class="list-group-item tag-1">
                            <a href="http://www.raydevblog.us/tag/key-value-store.html">
                                key-value store
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://www.raydevblog.us/tag/concurrency.html">
                                concurrency
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://www.raydevblog.us/tag/python.html">
                                python
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://www.raydevblog.us/tag/java.html">
                                java
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/consistent-hashing.html">
                                consistent hashing
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/distributed.html">
                                distributed
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/bloom-filter.html">
                                bloom filter
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/json.html">
                                json
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/machine-learning.html">
                                machine learning
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/two-phase-commit.html">
                                two-phase commit
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/logging.html">
                                logging
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/mongodb.html">
                                mongodb
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/data-structure.html">
                                data structure
                            </a>
                        </li>
                    </ul>
                </li>    
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://jinja.pocoo.org/" target="_blank">
                Jinja2
            </a>
        </li>
        <li class="list-group-item">
            <a href="#" target="_blank">
                You can modify those links in your config file
            </a>
        </li>
      </ul>
    </li>

        </ul>
    </section>

</aside>        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Ray Chen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://www.raydevblog.us/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://www.raydevblog.us/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://www.raydevblog.us/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'garudareiga'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
</body>
</html>