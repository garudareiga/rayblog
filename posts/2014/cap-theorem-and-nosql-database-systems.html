<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>CAP Theorem and NoSQL Database Systems - Ray's Thoughts and Writings</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://www.raydevblog.us/posts/2014/cap-theorem-and-nosql-database-systems.html">

        <meta name="author" content="Ray Chen" />
        <meta name="description" content="CAP Theorem CAP is an abbreviation for consistency, availability, and partition tolerance. The CAP Theorem states that in a distributed system, you can have only two of these properties, but not all three at once. One of them must be sacrificed. Consistency A read request in a distributed system sees ..." />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://www.raydevblog.us/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://www.raydevblog.us/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://www.raydevblog.us/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://www.raydevblog.us/theme/css/style.css" type="text/css"/>

        <link href="http://www.raydevblog.us/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Ray's Thoughts and Writings ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://www.raydevblog.us/" class="navbar-brand">
Ray's Thoughts and Writings            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://www.raydevblog.us/category/algorithm.html">Algorithm</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/data.html">Data</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/java.html">Java</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/misc.html">Misc</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/python.html">Python</a>
                        </li>
                        <li class="active">
                            <a href="http://www.raydevblog.us/category/system.html">System</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://www.raydevblog.us/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://www.raydevblog.us/posts/2014/cap-theorem-and-nosql-database-systems.html"
                       rel="bookmark"
                       title="Permalink to CAP Theorem and NoSQL Database Systems">
                        CAP Theorem and NoSQL Database Systems
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-10-15T21:00:00"> Wed 15 October 2014</time>
    </span>



    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2>CAP Theorem</h2>
<p>CAP is an abbreviation for consistency, availability, and partition tolerance. The <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP Theorem</a> states that in a distributed system, you can have only two of these properties, but not all three at once. One of them must be sacrificed. </p>
<h4>Consistency</h4>
<p>A read request in a distributed system sees all previously completed writes. Traditional ways to achieve this in relational database systems are distributed transactions. </p>
<h4>Availability</h4>
<p>The distributed system guarantees responses for requests within a reasonable amount of time, even though one or more nodes are down. To achieve availability data in a cluster must be replicated to a number of nodes, and every node must be ready to claim master status at any time.</p>
<h4>Partition Tolerance</h4>
<p>Nodes can be physically separated from each other, and are not able to reach each other at any point and for any length of time, when network partitions occur. During the partition, the distributed system should still be able to serve both read and write quests.</p>
<h4>CP and AP</h4>
<p>Given completely unreliable networks, we must tolerate partitions in a distributed system. It's considered impossible to offer both full consistency and 100% availability at the same time, there will always be trade-offs involved. </p>
<ul>
<li>CP - Consistency/Partition Tolerance: choose consistency over availability when your business requirements dictate atomic reads and writes.</li>
<li>AP - Availability/Partition Tolerance: choose availability over consistency when your business requirements allow for some flexibility and the system needs to continue to function in spite of external errors.
I
The <a href="http://blog.nahurst.com/visual-guide-to-nosql-systems">"Visual Guide to NoSQL Systems"</a> offers a quick overview of the major trade-offs involved with relational and NoSQL database systems.
<img alt="Alt text" src="http://www.raydevblog.us/images/nosql.png" /></li>
</ul>
<h2>Key-based NoSQL Database Systems</h2>
<p>The data model of a database specifies how data is logically organized. Its query model dictates how the data can be retrieved and updated. Common data models are the relational model, key-based model, or various graph models. Query languages include SQL, key lookups, and MapReduce <a href="http://aosabook.org/en/nosql.html">1</a>.</p>
<p>Key-based NoSQL systems restrict lookups on a dataset to a single key field. The key-based lookup model is beneficial because the database has a consistent query pattern - the entire workload consists of key lookups whose performance is relatively uniform and predictable.</p>
<h4>Key-Value Stores</h4>
<p>In key-value stores, such as Dynamo and Voldemort, each key is mapped to a value containing arbitrary data. The key-value store has no knowledge of the contents of its payload, and it might map the key to a <a href="http://en.wikipedia.org/wiki/Binary_large_object">blob</a> containing JSON or binary format. In order to use structured formats to store complex data for a key, developers must operate against the data in the application space. Key-value stores shine in the simplicity of their query model.</p>
<h4>Key-Data Structure Stores</h4>
<p>Key-data structure stores assign each value a type. In Redis, the available types are integer, string, list, set, and sorted set. By providing simple type-specific functionality while avoiding multi-key operations such as aggregation or joins, Redis balances functionality and performance.</p>
<h4>Key-Document Stores</h4>
<p>Key-document stores, such as CouchDB9, MongoDB10, and Riak11, map a key to some document that contains structured information. These systems store documents in a JSON or JSON-like format. They store lists and dictionaries, which can be embedded recursively inside one-another.</p>
<h4>BigTable Column Family Stores</h4>
<p>HBase and Cassandra are based on Google's BigTable. In this model, a key identifies a row, which contains data stored in one or more Column Families (CFs). Within a CF, each row can contain multiple columns. The values within each column are timestamped, so that several versions of a row-column mapping can live within a CF. Conceptually, one can think of Column Families as storing complex keys of the form (row ID, CF, column, timestamp), mapping to values which are sorted by their keys.</p>
<h2>Data Durability</h2>
<p>Different NoSQL systems make different data durability guarantees in order to improve performance. No all NoSQL systems protect us against failures.</p>
<h4>Single-server Durability</h4>
<p>The simplest form of durability is a single-server durability. The single-server durability usually means writing the changed data to disk, which often bottlenecks your workload. To ensure efficient single-server durability, we need minimize the number of random writes between <em>fsync</em> system calls, and maximize the number of sequential writes per hard drive.</p>
<ul>
<li>Control <em>fsync</em> frequency: Memcached offers no on-disk durability in exchange for extremely fast in-memory operations. Redis offers developers several options for when to call <em>fsync</em>. </li>
<li>Increase sequential writes by logging: To reduce random writes, systems such as Cassandra, HBase, Redis, and Riak append update operations to a sequentially-written log file, which is frequently fsynced.</li>
</ul>
<h4>Multi-server Durability</h4>
<p>Many NoSQL systems offer multi-server durability by copying data across nodes.</p>
<ul>
<li>Redis takes a traditional <strong>master-slave</strong> approach to replicating data. All operations executed against a master are communicated in a log-like fashion to slave machines, which replicate the operations on their own hardware. If a master fails, a slave can step in and serve the data from the state of the operation log that it received from the master. CouchDB facilitates a similar form of directional replication.</li>
<li>MongoDB provides the notion of replica sets, where some number of servers are responsible for storing each document. It gives developers the option of ensuring that all replicas have received updates, or to proceed without ensuring that replicas have the most recent data.</li>
<li>HBase receives multi-server durability through HDFS. All writes are replicated to two or more HDFS nodes before returning control to the user, ensuring multi-server durability.</li>
<li>Riak, Cassandra, and Voldemort support quorum-based configurable forms of replication. They allow the user to specify $N$, the number of nodes which should have a copy of the data, and $W &lt; N$, the number of machines that should confirm the data has been written before returning control to the user.</li>
</ul>
<h2>Horizontal Scalability</h2>
<h4>Do Not Shard</h4>
<p>There are two ways to scale without sharding: <strong>read replicas</strong> and <strong>caching</strong>. Read replicas and caching allow us to scale up our read-heave workloads.</p>
<ul>
<li>Read replicas: Make copies of the data on multiple nodes. All write requests still go to a master node. Read requests go to nodes which replicate the data, and are often slightly stale with respect to the data on the write master.</li>
<li>Caching: Memcached dedicates blocks of memory on multiple nodes to cache data from data storage. Memcached clients distribute load across Memcached installations on different nodes.</li>
</ul>
<h4>Consistent Hashing</h4>
<h4>Range Partitioning</h4>
<p>In the range partitioning approach, some nodes in our system keep metadata about which nodes contain which key ranges. This range partitioning splits the keyspace into ranges, which each key range being managed by one machine and potentially replicated to others. </p>
<ul>
<li>HBase employs Google BigTable's hierarchical approach to range-partitioning. THe master server maintains the tablet assignment in a metadata table. The metadata table is also sharded into tablets, when this metadata gets large. Underlying tablet data is stored in HDFS, and HDFS handles data replication and consistency among replicas. ZooKeeper manage secondary master servers and tablet server reassignment.</li>
<li>MongoDB use configuration nodes to specify which storage nodes is responsible for which key ranges. These configuration nodes stay in sync through a protocol called <strong>two-phase commit</strong>. Storage nodes are arranged in replica sets to handle replication.</li>
</ul>
<h2>Consistency</h2>
<p>There are two major approaches to data consistency in the NoSQL systems. The first is <strong>strong consistency</strong>, where all replicas remain in sync. The second is <strong>eventual consistency</strong>, where replicas are allowed to get out of sync, but eventually catch up with one-another.</p>
<h3>References</h3>
<ul>
<li><a href="http://robertgreiner.com/2014/08/cap-theorem-revisited">CAP Theorem: Revisited</a></li>
<li><a href="http://aosabook.org/en/nosql.html">The NoSQL Ecosystem</a></li>
</ul><script type= "text/javascript">
    if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
        var mathjaxscript = document.createElement('script');
        mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
        mathjaxscript.type = 'text/javascript';
        mathjaxscript.src = 'https:' == document.location.protocol
                ? 'https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'
                : 'http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
        mathjaxscript[(window.opera ? "innerHTML" : "text")] =
            "MathJax.Hub.Config({" +
            "    config: ['MMLorHTML.js']," +
            "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
            "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
            "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
            "    displayAlign: 'center'," +
            "    displayIndent: '0em'," +
            "    showMathMenu: true," +
            "    tex2jax: { " +
            "        inlineMath: [ ['$','$'] ], " +
            "        displayMath: [ ['$$','$$'] ]," +
            "        processEscapes: true," +
            "        preview: 'TeX'," +
            "    }, " +
            "    'HTML-CSS': { " +
            "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
            "    } " +
            "}); ";
        (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
    }
</script>

            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'garudareiga'; // required: replace example with your forum shortname

                    var disqus_identifier = 'cap-theorem-and-nosql-database-systems';
                var disqus_url = 'http://www.raydevblog.us/posts/2014/cap-theorem-and-nosql-database-systems.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item"><a href="http://www.linkedin.com/in/leichen1983"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
                    <li class="list-group-item"><a href="https://twitter.com/garudareiga"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
                    <li class="list-group-item"><a href="https://github.com/garudareiga"><i class="fa fa-github-square fa-lg"></i> github</a></li>
                    <li class="list-group-item"><a href="http://www.raydevblog.us/feeds/all.atom.xml"><i class="fa fa-rss-square fa-lg"></i> rss</a></li>
                  </ul>
                </li>



                <li class="list-group-item"><a href="http://www.raydevblog.us/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                    <ul class="list-group " id="tags">
                        <li class="list-group-item tag-1">
                            <a href="http://www.raydevblog.us/tag/key-value-store.html">
                                key-value store
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://www.raydevblog.us/tag/concurrency.html">
                                concurrency
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://www.raydevblog.us/tag/python.html">
                                python
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://www.raydevblog.us/tag/java.html">
                                java
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/consistent-hashing.html">
                                consistent hashing
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/json.html">
                                json
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/machine-learning.html">
                                machine learning
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/logging.html">
                                logging
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/two-phase-commit.html">
                                two-phase commit
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/bloom-filter.html">
                                bloom filter
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/distributed.html">
                                distributed
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/mongodb.html">
                                mongodb
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/data-structure.html">
                                data structure
                            </a>
                        </li>
                    </ul>
                </li>    
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://jinja.pocoo.org/" target="_blank">
                Jinja2
            </a>
        </li>
        <li class="list-group-item">
            <a href="#" target="_blank">
                You can modify those links in your config file
            </a>
        </li>
      </ul>
    </li>

        </ul>
    </section>

</aside>        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Ray Chen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://www.raydevblog.us/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://www.raydevblog.us/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://www.raydevblog.us/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'garudareiga'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
</body>
</html>