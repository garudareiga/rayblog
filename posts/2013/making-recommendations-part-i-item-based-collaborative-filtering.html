<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Making Recommendations Part I - Item-based Collaborative Filtering - Ray's Thoughts and Writings</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://www.raydevblog.us/posts/2013/making-recommendations-part-i-item-based-collaborative-filtering.html">

        <meta name="author" content="Ray Chen" />
        <meta name="keywords" content="data mining,machine learning,json,mongodb" />
        <meta name="description" content="Recommender systems are popular on e-commerce web sites, to make personalized recommendations for products or services. Using the MovieLens 100k dataset, I plan to build a recommnender system, which makes automatic recommendations when a user inputs a list of movie ratings. The &#34;MovieLens 100k&#34; data set consists of: 10K ratings ..." />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://www.raydevblog.us/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://www.raydevblog.us/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://www.raydevblog.us/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://www.raydevblog.us/theme/css/style.css" type="text/css"/>

        <link href="http://www.raydevblog.us/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Ray's Thoughts and Writings ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://www.raydevblog.us/" class="navbar-brand">
Ray's Thoughts and Writings            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://www.raydevblog.us/category/data-structure-and-algorithm.html">Data structure and algorithm</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/java.html">Java</a>
                        </li>
                        <li class="active">
                            <a href="http://www.raydevblog.us/category/machine-learning.html">Machine learning</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/miscellaneous.html">Miscellaneous</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/python.html">Python</a>
                        </li>
                        <li >
                            <a href="http://www.raydevblog.us/category/system-design.html">System design</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://www.raydevblog.us/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://www.raydevblog.us/posts/2013/making-recommendations-part-i-item-based-collaborative-filtering.html"
                       rel="bookmark"
                       title="Permalink to Making Recommendations Part I - Item-based Collaborative Filtering">
                        Making Recommendations Part I - Item-based Collaborative Filtering
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2013-12-08T10:00:00"> Sun 08 December 2013</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://www.raydevblog.us/tag/data-mining.html">data mining</a>
        /
	<a href="http://www.raydevblog.us/tag/machine-learning.html">machine learning</a>
        /
	<a href="http://www.raydevblog.us/tag/json.html">json</a>
        /
	<a href="http://www.raydevblog.us/tag/mongodb.html">mongodb</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Recommender systems are popular on e-commerce web sites, to make personalized
recommendations for products or services. Using the <a href="http://www.grouplens.org/datasets/movielens">MovieLens 100k</a> 
dataset, I plan to build a recommnender system, which makes automatic recommendations 
when a user inputs a list of movie ratings.</p>
<p>The "MovieLens 100k" data set consists of:</p>
<ul>
<li>10K ratings (1-5) from <em>943</em> users on <em>1682</em> movies.</li>
<li>Each user has rated at least 20 movies.</li>
<li>Simple demographic info for the users (age, gender, occupation, zip)</li>
</ul>
<h1>User-based or Item-based Collaborative Filtering</h1>
<p>Collaborative Filtering (CF) is the most popular recommendation technique. CF works by
building a database of preferences for items by users, and generates recommendations or
makes predictions based on user-user similarity or item-item similarity. A user-based 
CF algorithm represents a user as a N-dimensinal vector of items, where N is the number 
of distinct items. The algorithm generates recommendations for a user based on a few other 
users who are most similar to him/her. Rather than matching user to user, item-based CF 
represents an item as a M-dimensinal vector of users, where M is the number of distinct users.
It matches an user's rated items to similar items, then combines those similar items into 
a recommendation list.</p>
<p>After parsing the "MovieLens 100K" data set, we have a user-item representation matrix (943x1682).
In the case of user-based CF the similarity is computed along the rows of the matrix, while in the case of 
item-based CF the similarity is computed along the column. In practice, user-based CF shows
weakness evaluating large, sparse datasets. Thus, I choose item-based CF to build my recommender. 
The main idea here is to analyze the user-item matrix to identify relations between different items
and then to use these relations to compute the prediction score for a given user-item pair.</p>
<h1>Similarity Computation</h1>
<p>One critical step in the item-based CF algorithm is to compute the similarity between the items.
The basic idea in similarity computation between two items i and j is to first isolate the users
who have rated both of these items, and then to apply a similarity computation technique to determine
the similarity. There are a number of different ways to compute the similarity between items, such
as Euclidean distance, Jaccord coefficient, cosine similarity, Pearson's correlation coefficient. 
Euclidean distance is often used for dense, continuous data. For sparse data, which often consists 
of asymmetric attributes, we typically employ Jaccord coefficient or cosine similarity that ignore 
0-0 matches. However, Jaccord coefficient or cosine similariy does not take the scale of data into 
account. Thus, I choose adjusted cosine similarity and Pearson's correlation for similarity compuation. 
After similarity compuation, we can build a item similarity dictionary.</p>
<h3>Pearson's Correlation</h3>
<p>The similarity between two item i and j is measured by Pearson's correlation.  Let the set of users 
who both rated i and j are denoted by U, then the correlation is given by </p>
<p>\begin{equation}
sim(i, j) = \frac{\sum_{u \in U}(R_{u,i} - \overline{R_{i}})(R_{u,j} - \overline{R_{j}})}{\sqrt{\sum_{u \in U}(R_{u,i} - \overline{R_{i}})^2}\sqrt{\sum_{u \in U}(R_{u,j} - \overline{R_{j}})^2}}
\end{equation}</p>
<h3>Adjusted Consine Similarity</h3>
<p>The adjusted consine similarity substracts the corresponding user average from each co-rated pair.
The similarity between items i and j is given by</p>
<p>\begin{equation}
sim(i, j) = \frac{\sum_{u \in U}(R_{u,i} - \overline{R_{u}})(R_{u,j} - \overline{R_{u}})}{\sqrt{\sum_{u \in U}(R_{u,i} - \overline{R_{u}})^2}\sqrt{\sum_{u \in U}(R_{u,j} - \overline{R_{u}})^2}}
\end{equation}</p>
<h1>Recommendation Generation</h1>
<p>On an item i for a user u, we computes the prediction by computing the sum of ratings given by the user on the items
similar to i. Each rating is weighted by the corresponding similarity $s_{i,j}$ between items i and j. We can denote
the similar item set of item i as N, and the prediction $P_{u,i}$ as</p>
<p>\begin{equation}
P_{u,i} = \frac{\sum_{j \in N}(s_{i,j}*R_{u,j})} {\sum_{j \in N}(\mid s_{i,j} \mid)}
\end{equation}</p>
<p>The recommendations will consist of a set of similar items with high prediction values.</p>
<h1>Python Implementation</h1>
<p>A Python module of my recommender system is availabe in my <a href="https://github.com/garudareiga/PyDMML/blob/master/recommendation_movie_lens/Recommendation.py">github reposity</a>. The method to build a recommender system is as follows:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">Recommendation</span><span class="p">(</span><span class="n">num_user</span><span class="o">=</span><span class="mi">943</span><span class="p">,</span> <span class="n">num_item</span><span class="o">+</span><span class="mi">1682</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">parse_data</span><span class="p">(</span><span class="s">&#39;ml-100k/u.data&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">do_item_based_collaborative_filtering</span><span class="p">(</span><span class="n">similarity</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">item_similarity_pearson</span><span class="p">,</span> <span class="n">num_similar_items</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>


<p>Next, it makes prediction for a random user as follows:</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">num_user</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">make_recommendations</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</pre></div>


<h1>Performance</h1>
<p>In a practical scenario, we usually have a set of item that is static compared to the number of users
that changes most often. The static nature of items makes precomputing the item similarities possible.
One possible way is to compute all-to-all similarity and then performing a quick table look-up to retrieve
the similarity values. This offline computation of the similar-items table is extremely time intensive,
with $O(N^2M)$ as worst case. However, it's close to $O(NM)$ in practice, as most customers have very few
purchases. Although building the item similarity takes a long item, recommendations are 
almost instantaneous afterwards. Therefore, item-based CF is efficient for a large dataset, with the additional 
overhead of maintining the item similarity dictionary. This method, although saves time, requires an
$O(M^2)$ space for <em>M</em> items. In fact, we only need a small number of similar items to compute predictions.
For each item, we retain only the <em>K</em> most similar items, where <em>K</em> &lt;&lt; <em>M</em>, and record these item similarities.
Obviously, we observe a quality-performance trade-off: to ensure good quality we need have a large value <em>K</em>, which
leads to the performance problem. </p>
<p>In my project, the offline similarity precomputing takes about 30~40 minutes using Pearson's corelation to<br />
compute item similarity. For each item, I retain 100 most similar items and provide an option to store their similarity
values in a local JSON disk file, or in a MongoDB collection (One document correspond to one item with its 100 most
similar items and their similarity scores). At the start of recommendation, I simply load the precomputed similarity
information from the local JSON disk file or the MongoDB collection.</p><script type= "text/javascript">
    if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
        var mathjaxscript = document.createElement('script');
        mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
        mathjaxscript.type = 'text/javascript';
        mathjaxscript.src = 'https:' == document.location.protocol
                ? 'https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'
                : 'http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
        mathjaxscript[(window.opera ? "innerHTML" : "text")] =
            "MathJax.Hub.Config({" +
            "    config: ['MMLorHTML.js']," +
            "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
            "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
            "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
            "    displayAlign: 'center'," +
            "    displayIndent: '0em'," +
            "    showMathMenu: true," +
            "    tex2jax: { " +
            "        inlineMath: [ ['$','$'] ], " +
            "        displayMath: [ ['$$','$$'] ]," +
            "        processEscapes: true," +
            "        preview: 'TeX'," +
            "    }, " +
            "    'HTML-CSS': { " +
            "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
            "    } " +
            "}); ";
        (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
    }
</script>

            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'garudareiga'; // required: replace example with your forum shortname

                    var disqus_identifier = 'making-recommendations-part-i-item-based-collaborative-filtering';
                var disqus_url = 'http://www.raydevblog.us/posts/2013/making-recommendations-part-i-item-based-collaborative-filtering.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item"><a href="http://www.linkedin.com/in/leichen1983"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
                    <li class="list-group-item"><a href="https://twitter.com/garudareiga"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
                    <li class="list-group-item"><a href="https://github.com/garudareiga"><i class="fa fa-github-square fa-lg"></i> github</a></li>
                    <li class="list-group-item"><a href="http://www.raydevblog.us/feeds/all.atom.xml"><i class="fa fa-rss-square fa-lg"></i> rss</a></li>
                  </ul>
                </li>



                <li class="list-group-item"><a href="http://www.raydevblog.us/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                    <ul class="list-group " id="tags">
                        <li class="list-group-item tag-1">
                            <a href="http://www.raydevblog.us/tag/key-value-store.html">
                                key-value store
                            </a>
                        </li>
                        <li class="list-group-item tag-1">
                            <a href="http://www.raydevblog.us/tag/concurrency.html">
                                concurrency
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://www.raydevblog.us/tag/python.html">
                                python
                            </a>
                        </li>
                        <li class="list-group-item tag-2">
                            <a href="http://www.raydevblog.us/tag/java.html">
                                java
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/data-mining.html">
                                data mining
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/mongodb.html">
                                mongodb
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/machine-learning.html">
                                machine learning
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/logging.html">
                                logging
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/json.html">
                                json
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/two-phase-commit.html">
                                two-phase commit
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/data-structure.html">
                                data structure
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/bloom-filter.html">
                                bloom filter
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/consistent-hashing.html">
                                consistent hashing
                            </a>
                        </li>
                        <li class="list-group-item tag-4">
                            <a href="http://www.raydevblog.us/tag/distributed.html">
                                distributed
                            </a>
                        </li>
                    </ul>
                </li>    
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://jinja.pocoo.org/" target="_blank">
                Jinja2
            </a>
        </li>
        <li class="list-group-item">
            <a href="#" target="_blank">
                You can modify those links in your config file
            </a>
        </li>
      </ul>
    </li>

        </ul>
    </section>

</aside>        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Ray Chen
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://www.raydevblog.us/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://www.raydevblog.us/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://www.raydevblog.us/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'garudareiga'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
</body>
</html>